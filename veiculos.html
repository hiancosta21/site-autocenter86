<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auto Center 86 - Ve√≠culos</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-light">

    <nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4">
        <div class="container">
            <a class="navbar-brand" href="#">Auto Center 86</a>
            <div class="navbar-nav">
                <a class="nav-link" href="index.html">Clientes</a>
                <a class="nav-link active" href="veiculos.html">Ve√≠culos</a>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="card shadow">
            <div class="card-header bg-primary text-white">
                <h3>üöó Cadastro de Ve√≠culo</h3>
            </div>
            <div class="card-body">
                <form id="formVeiculo">
                    
                    <div class="mb-3">
                        <label class="form-label">De quem √© esse carro?</label>
                        <select id="clienteSelect" class="form-select" required>
                            <option value="" selected>Carregando clientes...</option>
                        </select>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Placa</label>
                            <input type="text" id="placa" class="form-control" required placeholder="ABC-1234">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Modelo</label>
                            <input type="text" id="modelo" class="form-control" placeholder="Ex: Gol 1.0">
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Marca</label>
                        <input type="text" id="marca" class="form-control" placeholder="Ex: Volkswagen">
                    </div>

                    <button type="submit" class="btn btn-success w-100">Salvar Ve√≠culo</button>
                </form>
                <div id="mensagem" class="mt-3"></div>
            </div>
        </div>

        <div class="mt-5">
            <h4>Ve√≠culos na Oficina:</h4>
            <ul id="listaVeiculos" class="list-group">
                </ul>
        </div>
    </div>

    <script>
        // --- SUAS CREDENCIAIS J√Å PREENCHIDAS ---
        const supabaseUrl = 'https://vfqjjbtewrmnyzyzhrif.supabase.co'
        const supabaseKey = 'sb_publishable_mNQJ_RqCldWrEXigUxW4Qg_5QufcVJX'
        
        const _supabase = supabase.createClient(supabaseUrl, supabaseKey)

        // 1. Carregar Clientes para o Dropdown
        async function carregarSelectClientes() {
            const { data, error } = await _supabase
                .from('clientes')
                .select('*')
                .order('nome', { ascending: true })
            
            const select = document.getElementById('clienteSelect');
            select.innerHTML = '<option value="" selected disabled>Selecione um cliente...</option>';

            if(data) {
                data.forEach(cliente => {
                    select.innerHTML += `<option value="${cliente.id}">${cliente.nome} | ${cliente.telefone}</option>`
                });
            }
        }

        // 2. Salvar Ve√≠culo
        document.getElementById('formVeiculo').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const clienteId = document.getElementById('clienteSelect').value;
            const placa = document.getElementById('placa').value;
            const modelo = document.getElementById('modelo').value;
            const marca = document.getElementById('marca').value;

            const { data, error } = await _supabase
                .from('veiculos')
                .insert([
                    { 
                        cliente_id: clienteId,
                        placa: placa,
                        modelo: modelo,
                        marca: marca
                    },
                ])

            if (error) {
                document.getElementById('mensagem').innerHTML = `<div class="alert alert-danger">${error.message}</div>`
            } else {
                document.getElementById('mensagem').innerHTML = `<div class="alert alert-success">Ve√≠culo Cadastrado!</div>`
                document.getElementById('formVeiculo').reset();
                carregarVeiculos(); 
                carregarSelectClientes();
            }
        });

        // 3. Listar Ve√≠culos
        async function carregarVeiculos() {
            const { data, error } = await _supabase
                .from('veiculos')
                .select('*, clientes(nome)') 
                .order('id', { ascending: false })

            const lista = document.getElementById('listaVeiculos');
            lista.innerHTML = '';

            if(data) {
                data.forEach(carro => {
                    const nomeDono = carro.clientes ? carro.clientes.nome : 'Dono desconhecido';
                    
                    lista.innerHTML += `
                    <li class="list-group-item">
                        <strong>${carro.modelo}</strong> (${carro.placa}) <br>
                        <small class="text-muted">Propriet√°rio: ${nomeDono}</small>
                    </li>`
                });
            }
        }

        carregarSelectClientes();
        carregarVeiculos();
    </script>
</body>
</html>